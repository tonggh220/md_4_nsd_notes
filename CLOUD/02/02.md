# openstack 安装

## 环境准备
openstack 主机
IP:192.168.1.10 内存:8G CPU:2 硬盘最小10G

nova 主机（nova01, nova02）
IP:192.168.1.11 内存:3G CPU:2 硬盘最小10G
IP:192.168.1.12 内存:3G CPU:2 硬盘最小10G

功能服务器 repo
IP:192.168.1.250 内存:1G CPU:2 硬盘最小20G
上传 RHEL7-extras.iso、RHEL7OSP-10.iso 到功能服务器

## 功能服务器安装配置

#### 时间源服务器

```shell
[root@repo ~]# yum install -y chrony
[root@repo ~]# vim /etc/chrony.conf
# 注释掉所有 server 开头的行，添加
server ntp.aliyun.com iburst
bindacqaddress 0.0.0.0
allow 0/0
local stratum 10
[root@repo ~]# systemctl enable chronyd
[root@repo ~]# systemctl restart chronyd
[root@repo ~]# ss -ltun  # 查看 123 端口是否被监听成功
```

#### 网络yum源服务器

```shell
[root@localhost ~]# yum install -y vsftpd
[root@localhost ~]# systemctl enable --now vsftpd
[root@localhost ~]# mkdir -p /var/ftp/{extras,openstack}
[root@localhost ~]# cd /var/iso
[root@localhost ~]# mount -t iso9660 -o ro,loop RHEL7-extras.iso /var/ftp/extras
[root@localhost ~]# mount -t iso9660 -o ro,loop RHEL7OSP-10.iso /var/ftp/openstack
# 在openstack上验证
[root@openstack ~]# curl ftp://192.168.1.250/
```

#### openstack 实验架构图例

```mermaid
graph TB
subgraph Windows/真机
  style Windows/真机 color:#ff0000
  subgraph nova01
    style nova01 color:#ff0000,fill:#99cc66
    H1(vm) --> N1(br-ex) --> P1(eth0)
    H2(vm) --> N1
    H3(vm) --> N1
    C1(nova-computer) --- X1(libvirtd)
  end
  subgraph nova02
    style nova02 color:#ff0000,fill:#99cc66
    C2(nova-computer) --- X2(libvirtd)
    H4(vm) --> N2(br-ex) --> P2(eth0)
    H5(vm) --> N2
    H6(vm) --> N2
  end
  subgraph openstack
    style openstack color:#ff0000,fill:#11aaff
    PP(管理节点)
  end
  PP --> C1
  PP --> C2
end
```

#### openstack系统环境安装配置

以下操作，openstack，nova01，nova02 都需要做

```shell
[root@openstack ~]# vim /etc/selinux/config
# 修改 SELINUX=disabled
[root@openstack ~]# yum -y remove firewalld-*
[root@openstack ~]# reboot
# 验证
[root@openstack ~]# sestatus 
SELinux status:                 disabled
[root@openstack ~]# rpm -qa |grep -i firewalld
[root@openstack ~]# 
```

卸载 NetworkManager

```shell
[root@localhost ~]# systemctl stop NetworkManager
[root@localhost ~]# yum remove -y NetworkManager
[root@localhost ~]# systemctl enable --now  network
```

网卡配置文件注解

* \# Generated by dracut initrd   # 注释
* DEVICE="eth0"                            # 驱动名称，与ifconfig 看到的名称一致
* ONBOOT="yes"	                         # 开机启动
* NM_CONTROLLED="no"         # 不接受 NetworkManager 控制
* TYPE="Ethernet"                         # 类型
* BOOTPROTO="static"                # 协议(dhcp|static|none)
* IPADDR="192.168.1.10"             # IP地址
* NETMASK="255.255.255.0"    # 子网掩码
* GATEWAY="192.168.1.254"     # 默认网关